<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Letter Race</title>
<style>
  html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#111; font-family: Arial, sans-serif; }
  canvas { display:block; touch-action:none; }
  #ui {
    position: absolute;
    top: 12px;
    left: 12px;
    color: #fff;
    font-size: 18px;
    background: rgba(0,0,0,0.35);
    padding: 10px 12px;
    border-radius: 12px;
    backdrop-filter: blur(4px);
  }
  #ui small { display:block; opacity:0.9; margin-top:6px; font-size: 14px; }
</style>
</head>
<body>

<div id="ui">
  Energie: <span id="energy">100</span>
  <small>Stuur met vinger, of muis</small>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

const uiEnergy = document.getElementById("energy");

function loadImg(src){
  const img = new Image();
  img.src = src;
  return img;
}

const carStraightImg = loadImg("car_straight.png");
const carLeftImg = loadImg("car_left.png");
const carRightImg = loadImg("car_right.png");

let energy = 100;
let roadScroll = 0;

const letters = "AEIOUMKSTPRLN".split("");
const items = [];

const state = {
  pointerX: canvas.width / 2,
  pointerActive: false,
  lastTime: performance.now()
};

const car = {
  x: canvas.width / 2,
  y: canvas.height * 0.78,
  targetX: canvas.width / 2,
  w: 140,
  h: 90,
  tilt: 0,
  speed: 8,
  steerDx: 0
};

CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
  const rr = Math.min(r, w/2, h/2);
  this.beginPath();
  this.moveTo(x + rr, y);
  this.arcTo(x + w, y, x + w, y + h, rr);
  this.arcTo(x + w, y + h, x, y + h, rr);
  this.arcTo(x, y + h, x, y, rr);
  this.arcTo(x, y, x + w, y, rr);
  this.closePath();
  return this;
};

function mod(n, m){
  return ((n % m) + m) % m;
}

function roadWidthAt(y){
  const t = y / canvas.height;
  const minW = canvas.width * 0.28;
  const maxW = canvas.width * 0.90;
  return minW + (maxW - minW) * (t ** 1.65);
}

/*
Rustige bocht, geen golfslag
Trage sinus met lage amplitude
*/
function roadCenterXAt(y){
  const t = y / canvas.height;

  const base = canvas.width / 2;
  const slow = Math.sin(roadScroll / 520) * (canvas.width * 0.045);
  const slow2 = Math.sin(roadScroll / 900 + 1.7) * (canvas.width * 0.018);

  const influence = (1 - t) ** 1.2;
  return base + (slow + slow2) * influence;
}

function roadEdgesAt(y){
  const w = roadWidthAt(y);
  const cx = roadCenterXAt(y);
  return { left: cx - w/2, right: cx + w/2, cx, w };
}

function sampleRoadPoints(stepY = 24){
  const pts = [];
  for(let y = 0; y <= canvas.height + stepY; y += stepY){
    const e = roadEdgesAt(y);
    pts.push({ y, left: e.left, right: e.right, cx: e.cx, w: e.w });
  }
  return pts;
}

function drawBackground(){
  const g = ctx.createLinearGradient(0,0,0,canvas.height);
  g.addColorStop(0, "#69b3ff");
  g.addColorStop(0.45, "#3b76c8");
  g.addColorStop(1, "#1a1a1a");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = "#2c8c3a";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function fillRoadPolygon(pts){
  ctx.beginPath();
  ctx.moveTo(pts[0].left, pts[0].y);
  for(let i = 1; i < pts.length; i++) ctx.lineTo(pts[i].left, pts[i].y);
  for(let i = pts.length - 1; i >= 0; i--) ctx.lineTo(pts[i].right, pts[i].y);
  ctx.closePath();

  ctx.fillStyle = "#4b4b4b";
  ctx.fill();
}

function strokeEdge(pts, side){
  ctx.beginPath();
  ctx.lineWidth = 6;
  ctx.strokeStyle = "rgba(255,255,255,0.95)";

  const x0 = side === "left" ? pts[0].left : pts[0].right;
  ctx.moveTo(x0, pts[0].y);

  for(let i = 1; i < pts.length; i++){
    const x = side === "left" ? pts[i].left : pts[i].right;
    ctx.lineTo(x, pts[i].y);
  }
  ctx.stroke();
}

// Dashes bewegen nu correct naar beneden door (p.y - scroll)
function drawEdgeDashes(pts, side){
  const scroll = roadScroll % 140;

  for(let i = 0; i < pts.length - 1; i++){
    const p = pts[i];
    const t = p.y / canvas.height;

    const dashEvery = 90 + t * 40;
    const dashLen = 36 + t * 32;

    const phase = mod((p.y - scroll), dashEvery);
    const on = phase < dashLen;
    if(!on) continue;

    const x = side === "left" ? p.left : p.right;
    const inset = side === "left" ? 10 : -10;

    ctx.lineWidth = 5 + t * 4;
    ctx.strokeStyle = "rgba(255,255,255,0.95)";
    ctx.beginPath();
    ctx.moveTo(x + inset, p.y);
    ctx.lineTo(x + inset, p.y + 18 + t * 20);
    ctx.stroke();
  }
}

function drawCenterDashes(pts){
  const scroll = roadScroll % 170;

  for(let i = 0; i < pts.length - 1; i++){
    const p = pts[i];
    const t = p.y / canvas.height;

    const every = 120 + t * 55;
    const len = 52 + t * 40;

    const phase = mod((p.y - scroll), every);
    if(phase > len) continue;

    const w = 10 + t * 10;

    ctx.strokeStyle = "rgba(255,240,160,0.95)";
    ctx.lineWidth = w;

    ctx.beginPath();
    ctx.moveTo(p.cx, p.y);
    ctx.lineTo(p.cx, p.y + 28 + t * 34);
    ctx.stroke();
  }
}

function drawRumble(pts, side){
  const scroll = roadScroll % 160;

  for(let i = 0; i < pts.length - 1; i++){
    const p = pts[i];
    const t = p.y / canvas.height;

    const every = 80 + t * 35;
    const len = 34 + t * 28;

    const phase = mod((p.y - scroll), every);
    const on = phase < len;
    if(!on) continue;

    const baseX = side === "left" ? p.left : p.right;

    const stripWidth = 14 + t * 10;
    const stripInset = 18 + t * 10;
    const dir = side === "left" ? 1 : -1;

    const isRed = ((Math.floor((p.y + roadScroll) / every)) % 2) === 0;
    ctx.fillStyle = isRed ? "#d63b3b" : "#f2f2f2";

    ctx.beginPath();
    ctx.moveTo(baseX + dir * stripInset, p.y);
    ctx.lineTo(baseX + dir * (stripInset + stripWidth), p.y);
    ctx.lineTo(baseX + dir * (stripInset + stripWidth + 2), p.y + 18 + t * 18);
    ctx.lineTo(baseX + dir * (stripInset + 2), p.y + 18 + t * 18);
    ctx.closePath();
    ctx.fill();
  }
}

function drawRoad(){
  const pts = sampleRoadPoints(26);

  fillRoadPolygon(pts);

  strokeEdge(pts, "left");
  strokeEdge(pts, "right");

  drawRumble(pts, "left");
  drawRumble(pts, "right");

  drawEdgeDashes(pts, "left");
  drawEdgeDashes(pts, "right");

  drawCenterDashes(pts);

  const v = ctx.createRadialGradient(canvas.width/2, canvas.height*0.72, canvas.width*0.2, canvas.width/2, canvas.height*0.72, canvas.width*0.95);
  v.addColorStop(0, "rgba(0,0,0,0)");
  v.addColorStop(1, "rgba(0,0,0,0.35)");
  ctx.fillStyle = v;
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

function chooseCarSprite(){
  if(car.steerDx < -18) return carLeftImg;
  if(car.steerDx > 18) return carRightImg;
  return carStraightImg;
}

function drawCar(){
  const base = Math.min(canvas.width, canvas.height);

  // Auto 20 procent groter
  const carW = Math.max(144, base * 0.228);
  const carH = carW * 0.62;

  car.w = carW;
  car.h = carH;

  const img = chooseCarSprite();

  ctx.save();
  ctx.translate(car.x, car.y);

  ctx.rotate(car.tilt * 0.55);

  ctx.fillStyle = "rgba(0,0,0,0.25)";
  ctx.beginPath();
  ctx.ellipse(0, carH*0.36, carW*0.34, carH*0.22, 0, 0, Math.PI*2);
  ctx.fill();

  if(img.complete && img.naturalWidth){
    ctx.drawImage(img, -carW/2, -carH/2, carW, carH);
  } else {
    ctx.fillStyle = "red";
    ctx.fillRect(-carW/2, -carH/2, carW, carH);
  }

  ctx.restore();
}

function drawItems(){
  items.forEach(item => {
    const scale = 0.85 + (item.y / canvas.height) * 0.55;
    const size = item.size * scale;

    ctx.fillStyle = "rgba(255,215,80,0.95)";
    ctx.roundRect(item.x - size/2, item.y - size/2, size, size, 10);
    ctx.fill();

    ctx.strokeStyle = "rgba(0,0,0,0.25)";
    ctx.lineWidth = 3;
    ctx.stroke();

    ctx.fillStyle = "#111";
    ctx.font = `bold ${Math.floor(26*scale)}px Arial`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(item.letter, item.x, item.y + 1);
  });
}

function setPointer(clientX){
  state.pointerX = clientX;
  state.pointerActive = true;
}

canvas.addEventListener("touchstart", e => setPointer(e.touches[0].clientX), {passive:true});
canvas.addEventListener("touchmove", e => setPointer(e.touches[0].clientX), {passive:true});
canvas.addEventListener("mousedown", e => setPointer(e.clientX));
canvas.addEventListener("mousemove", e => { if(state.pointerActive) setPointer(e.clientX); });
window.addEventListener("mouseup", () => state.pointerActive = false);
window.addEventListener("touchend", () => state.pointerActive = false, {passive:true});

function clampToRoad(x, y){
  const e = roadEdgesAt(y);
  const pad = car.w * 0.34;
  return Math.min(e.right - pad, Math.max(e.left + pad, x));
}

function spawnItem(){
  const ySpawn = -40;
  const e = roadEdgesAt(canvas.height * 0.32);
  const margin = 90;
  const x = e.left + margin + Math.random() * (e.w - margin * 2);

  items.push({
    x,
    y: ySpawn,
    letter: letters[Math.floor(Math.random() * letters.length)],
    size: 44,
    vy: 3.7
  });
}
setInterval(spawnItem, 1200);

function update(dt){
  energy -= 0.025 * dt;
  energy = Math.max(0, Math.min(140, energy));
  uiEnergy.textContent = Math.floor(energy);

  roadScroll += car.speed * dt;

  car.targetX = clampToRoad(state.pointerX, car.y);

  const dx = car.targetX - car.x;
  car.steerDx = dx;

  car.x += dx * (0.075 * dt);

  const desiredTilt = Math.max(-0.22, Math.min(0.22, dx / (canvas.width * 0.9)));
  car.tilt += (desiredTilt - car.tilt) * (0.08 * dt);

  for(let i = items.length - 1; i >= 0; i--){
    const it = items[i];
    it.y += it.vy * dt;

    const e = roadEdgesAt(it.y);
    const margin = 80;
    it.x = Math.min(e.right - margin, Math.max(e.left + margin, it.x));

    const carW = car.w * 0.75;
    const carH = car.h * 0.75;

    if(Math.abs(it.x - car.x) < (carW/2) && Math.abs(it.y - car.y) < (carH/2)){
      energy = Math.min(140, energy + 12);
      items.splice(i, 1);
      continue;
    }
    if(it.y > canvas.height + 140) items.splice(i, 1);
  }
}

function draw(){
  drawBackground();
  drawRoad();
  drawItems();
  drawCar();

  if(energy <= 0){
    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "#fff";
    ctx.font = "bold 44px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("Oeps, leeg", canvas.width/2, canvas.height/2 - 20);
    ctx.font = "22px Arial";
    ctx.fillText("Pak letters om op te laden", canvas.width/2, canvas.height/2 + 28);
    ctx.fillText("Tik om opnieuw te starten", canvas.width/2, canvas.height/2 + 62);
  }
}

function loop(now){
  const dtMs = now - state.lastTime;
  state.lastTime = now;

  const dt = Math.min(3, dtMs / (1000/60));

  if(energy > 0) update(dt);
  draw();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function restart(){
  if(energy > 0) return;
  energy = 100;
  items.length = 0;
}
canvas.addEventListener("touchstart", restart, {passive:true});
canvas.addEventListener("mousedown", restart);
</script>
</body>
</html>a