<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Letter Race</title>
<style>
  html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#111; font-family: Arial, sans-serif; }
  canvas { display:block; }
  #ui{
    position:absolute; top:12px; left:12px;
    color:#fff; font-size:18px;
    background:rgba(0,0,0,.35);
    padding:10px 12px; border-radius:12px;
    backdrop-filter: blur(4px);
  }
  #ui .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    background:rgba(0,0,0,.28);
  }
  .targetBox{
    width:34px; height:34px; border-radius:10px;
    display:inline-flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.18);
    border:2px solid rgba(255,255,255,.35);
    font-weight:700;
  }
</style>
</head>
<body>

<div id="ui">
  <div class="row">
    <span class="pill">Energie: <span id="energy">100</span></span>
    <span class="pill">Letter: <span class="targetBox" id="targetLetter">a</span></span>
    <span class="pill">Tempo: <span id="tempo">1.00</span></span>
  </div>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
addEventListener("resize", resize);
resize();

const uiEnergy = document.getElementById("energy");
const uiTarget = document.getElementById("targetLetter");
const uiTempo  = document.getElementById("tempo");

function loadImg(src){ const img = new Image(); img.src = src; return img; }
const carStraight = loadImg("car_straight.png");
const carLeft = loadImg("car_left.png");
const carRight = loadImg("car_right.png");
const treeImg = loadImg("tree.png");

function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function mod(n,m){ return ((n % m) + m) % m; }

let energy = 100;
let roadScroll = 0;
let tempoFactor = 1.0;

const letters = "aeioumkstprln".split("");
let targetLetter = letters[Math.floor(Math.random()*letters.length)];
uiTarget.textContent = targetLetter;

let targetTimer = 0;
const TARGET_SWITCH_SECONDS = 9;

const state = { lane: 1, lastTime: performance.now() };
const car = { x: canvas.width/2, y: canvas.height * 0.78, tilt: 0, steerDx: 0, w: 150, h: 90 };

const items = [];
const MAX_ITEMS = 2;
const SPAWN_FRAMES_BASE = 170;

const SPEED_UP = 0.12;
const SPEED_DOWN = 0.10;
const SPEED_MIN = 0.70;
const SPEED_MAX = 2.20;
const RELAX_TO_ONE = 0.004;

/* bomen */
const trees = [];
const MAX_TREES = 4;
let treeSpawnTimer = 0;
const TREE_SPAWN_FRAMES_BASE = 240;

function spawnTree(){
  const side = Math.random() < 0.5 ? "left" : "right";
  const distanceFactor = 1.4 + Math.random()*0.5;
  trees.push({ side, y:-260, vy:6, distanceFactor });
}

function updateTrees(dt){
  treeSpawnTimer += dt;
  if(treeSpawnTimer > TREE_SPAWN_FRAMES_BASE/tempoFactor){
    treeSpawnTimer = 0;
    if(trees.length < MAX_TREES) spawnTree();
  }
  for(let i=trees.length-1;i>=0;i--){
    trees[i].y += trees[i].vy * tempoFactor * dt;
    if(trees[i].y > canvas.height+400) trees.splice(i,1);
  }
}

function drawTrees(){
  for(const tr of trees){
    const t = clamp(tr.y / canvas.height, 0, 1);
    const w = 60 + t*230;
    const h = w*1.05;
    const e = roadEdgesAt(tr.y);
    const margin = (100 + t*260)*tr.distanceFactor;
    const x = tr.side==="left" ? e.left-margin : e.right+margin;

    ctx.fillStyle="rgba(0,0,0,.18)";
    ctx.beginPath();
    ctx.ellipse(x, tr.y+h*.42, w*.26, h*.1,0,0,Math.PI*2);
    ctx.fill();

    if(treeImg.complete) ctx.drawImage(treeImg,x-w/2,tr.y-h*.62,w,h);
  }
}

/* weg geometrie */
function roadWidthAt(y){
  const t = clamp(y / canvas.height, 0, 1);
  return canvas.width * 0.30 + (canvas.width * 0.90 - canvas.width * 0.30) * (t ** 1.6);
}
function roadCenterXAt(y){
  const t = clamp(y / canvas.height, 0, 1);
  const slow = Math.sin(roadScroll / 720) * (canvas.width * 0.03);
  return canvas.width / 2 + slow * (1 - t);
}
function roadEdgesAt(y){
  const w = roadWidthAt(y);
  const cx = roadCenterXAt(y);
  return { left: cx - w/2, right: cx + w/2, cx, w };
}
function laneX(lane, y){
  const e = roadEdgesAt(y);
  return e.left + (e.w/3)*(lane+.5);
}

/* tekenen */
function drawGrass(){
  ctx.fillStyle="#3aa64b";
  ctx.fillRect(0,0,canvas.width,canvas.height);
}

function drawRoad(){
  const pts=[];
  for(let y=0;y<=canvas.height+28;y+=28){
    const e=roadEdgesAt(y);
    pts.push({y,left:e.left,right:e.right,cx:e.cx,w:e.w});
  }

  ctx.beginPath();
  ctx.moveTo(pts[0].left,pts[0].y);
  for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].left,pts[i].y);
  for(let i=pts.length-1;i>=0;i--) ctx.lineTo(pts[i].right,pts[i].y);
  ctx.closePath();
  ctx.fillStyle="#505050";
  ctx.fill();

  /* brede buitenband */
  for(let i=0;i<pts.length-1;i++){
    const p1=pts[i],p2=pts[i+1];
    const t=clamp(p1.y/canvas.height,0,1);
    const bandW=3+t*22,off=bandW*.75;
    ctx.strokeStyle="rgba(255,255,255,.20)";
    ctx.lineWidth=bandW;
    ctx.lineCap="round";
    ctx.beginPath(); ctx.moveTo(p1.left-off,p1.y); ctx.lineTo(p2.left-off,p2.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(p1.right+off,p1.y); ctx.lineTo(p2.right+off,p2.y); ctx.stroke();
  }

  /* randlijnen */
  ctx.strokeStyle="rgba(255,255,255,.6)";
  ctx.lineWidth=4;
  ctx.lineCap="round";
  ctx.beginPath();
  ctx.moveTo(pts[0].left+3,pts[0].y);
  for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].left+3,pts[i].y);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(pts[0].right-3,pts[0].y);
  for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].right-3,pts[i].y);
  ctx.stroke();

  /* middenstrepen */
  const dashScroll=roadScroll%260;
  for(const p of pts){
    const t=clamp(p.y/canvas.height,0,1);
    const phase=mod(p.y-dashScroll,260);
    if(phase>95) continue;
    ctx.strokeStyle="rgba(255,245,190,.75)";
    ctx.lineWidth=12+t*10;
    ctx.lineCap="round";
    ctx.beginPath();
    ctx.moveTo(p.cx,p.y);
    ctx.lineTo(p.cx,p.y+28+t*48);
    ctx.stroke();
  }
}

/* overige */
function drawItem(it){
  const t=clamp(it.y/canvas.height,0,1);
  const size=26+t*125;
  ctx.fillStyle=it.isTarget?"rgba(170,225,255,.95)":"rgba(255,220,120,.95)";
  ctx.fillRect(it.x-size/2,it.y-size/2,size,size);
  ctx.fillStyle="#111";
  ctx.font=`700 ${14+t*58}px Arial`;
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  ctx.fillText(it.letter,it.x,it.y);
}

function drawCar(){
  const base=Math.min(canvas.width,canvas.height);
  const w=Math.max(176,base*.275);
  const h=w*.62;
  car.w=w; car.h=h;
  const img=car.steerDx<-18?carLeft:car.steerDx>18?carRight:carStraight;
  ctx.save();
  ctx.translate(car.x,car.y);
  ctx.rotate(car.tilt*.4);
  if(img.complete) ctx.drawImage(img,-w/2,-h/2,w,h);
  ctx.restore();
}

/* game loop */
function update(dt){
  energy=Math.max(0,energy-.018*dt);
  uiEnergy.textContent=Math.floor(energy);

  roadScroll+=9.2*tempoFactor*dt;
  uiTempo.textContent=tempoFactor.toFixed(2);

  updateTrees(dt);

  const targetX=laneX(state.lane,car.y);
  const dx=targetX-car.x;
  car.steerDx=dx;
  car.x+=dx*.085*dt;
  car.tilt+=(clamp(dx/(canvas.width*.75),-.28,.28)-car.tilt)*.09*dt;
}

function draw(){
  drawGrass();
  drawRoad();
  drawTrees();
  drawCar();
}

function loop(now){
  const dt=Math.min(3,(now-state.lastTime)/(1000/60));
  state.lastTime=now;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

canvas.addEventListener("pointerdown",(e)=>{
  const x=e.clientX;
  if(x<canvas.width/3) state.lane=0;
  else if(x<canvas.width*2/3) state.lane=1;
  else state.lane=2;
});
</script>
</body>
</html>